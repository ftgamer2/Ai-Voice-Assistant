<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FTGAMERV2 AI - @FTGAMERV2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;600&display=swap');

        :root {
            --primary: #00b0ff;
            --secondary: #0066ff;
            --accent: #0088ff;
            --bg-dark: #0a0a1a;
            --bg-panel: rgba(10, 10, 26, 0.95);
            --border: rgba(0, 176, 255, 0.3);
            --ai-color: #00b0ff;
            --user-color: #0066ff;
            --error: #ff5555;
            --success: #55ff55;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }

        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .grid-bg {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 176, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 102, 255, 0.05) 0%, transparent 50%),
                linear-gradient(90deg, rgba(0, 176, 255, 0.03) 1px, transparent 1px),
                linear-gradient(rgba(0, 176, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px; 
            pointer-events: none; 
            z-index: -1;
        }

        /* --- HEADER --- */
        header {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            z-index: 100;
            flex-shrink: 0;
        }

        .brand {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary);
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .owner-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: rgba(0, 136, 255, 0.2);
            border: 1px solid var(--accent);
            border-radius: 12px;
            color: #aaccff;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-badge {
            font-size: 0.7rem; 
            padding: 3px 6px;
            border: 1px solid var(--primary); 
            color: var(--primary);
            border-radius: 4px; 
            background: rgba(0, 176, 255, 0.1);
            text-transform: uppercase; 
            font-weight: bold;
            display: flex; 
            align-items: center; 
            gap: 4px;
        }

        .status-dot {
            width: 6px; 
            height: 6px; 
            background: var(--primary);
            border-radius: 50%; 
            box-shadow: 0 0 5px var(--primary);
            animation: pulse 2s infinite;
        }

        .settings-btn {
            background: rgba(0, 176, 255, 0.1);
            border: 1px solid var(--border);
            color: var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* --- AVATAR --- */
        .avatar-container {
            flex-shrink: 0; 
            display: flex; 
            justify-content: center;
            align-items: center; 
            padding: 10px 0; 
            position: relative;
        }

        .avatar-ring {
            width: 90px; 
            height: 90px; 
            border: 2px solid var(--primary);
            border-radius: 50%; 
            position: relative;
            display: flex; 
            justify-content: center; 
            align-items: center;
            box-shadow: 0 0 30px rgba(0, 176, 255, 0.3);
            animation: breathe 4s ease-in-out infinite;
        }

        .avatar-ring::before {
            content: ''; 
            position: absolute; 
            inset: -4px;
            border: 2px dashed var(--secondary); 
            border-radius: 50%;
            animation: spin 10s linear infinite;
        }

        .face-structure {
            width: 65px; 
            height: 65px;
            background: radial-gradient(circle, rgba(0, 176, 255, 0.3), #000);
            border-radius: 40% 40% 50% 50%; 
            position: relative;
            border: 1px solid var(--primary);
            box-shadow: inset 0 0 20px rgba(0, 176, 255, 0.4);
            overflow: hidden;
        }

        .eyes-container {
            position: absolute; 
            top: 35%; 
            width: 100%;
            display: flex; 
            justify-content: space-evenly;
        }
        
        .eye {
            width: 14px; 
            height: 4px; 
            background-color: var(--primary);
            border-radius: 50% 50% 0 0; 
            box-shadow: 0 0 10px var(--primary);
            animation: blink 4s infinite;
        }

        .mouth-container {
            position: absolute; 
            bottom: 25%; 
            left: 50%;
            transform: translateX(-50%); 
            display: flex; 
            gap: 2px;
            align-items: center; 
            height: 15px;
        }
        
        .bar {
            width: 2px; 
            height: 2px; 
            background: var(--primary);
            border-radius: 1px; 
            transition: height 0.1s;
        }

        /* --- CHAT AREA --- */
        .chat-area {
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 12px;
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .msg {
            max-width: 85%; 
            padding: 10px 14px; 
            border-radius: 15px;
            font-size: 0.9rem; 
            line-height: 1.4; 
            animation: fadeUp 0.3s ease-out;
            word-wrap: break-word; 
            position: relative;
        }
        
        .msg.ai {
            align-self: flex-start; 
            background: rgba(0, 176, 255, 0.15);
            border: 1px solid var(--primary); 
            border-top-left-radius: 0; 
            color: #e6f7ff;
        }
        
        .msg.user {
            align-self: flex-end; 
            background: rgba(0, 102, 255, 0.2);
            border: 1px solid rgba(0, 102, 255, 0.5); 
            border-top-right-radius: 0;
            color: #fff; 
            text-align: right;
        }
        
        .msg.error {
            align-self: flex-start; 
            background: rgba(255, 85, 85, 0.15);
            border: 1px solid var(--error); 
            border-top-left-radius: 0; 
            color: #ffe6e6;
        }
        
        .msg strong { 
            color: var(--primary); 
            font-weight: 700; 
        }
        
        .msg pre { 
            background: rgba(0,0,0,0.5); 
            padding: 8px; 
            margin: 5px 0; 
            border-radius: 5px; 
            overflow-x: auto; 
            border: 1px solid #333; 
            text-align: left; 
            font-size: 0.8rem;
        }
        
        .msg code { 
            font-family: 'Courier New', monospace; 
            color: #66ccff; 
            background: rgba(0,0,0,0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* --- INPUT AREA --- */
        .input-wrapper {
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 8px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            flex-shrink: 0;
        }

        .preview-container {
            font-size: 0.75rem; 
            color: var(--primary);
            margin-bottom: 6px; 
            padding-left: 5px;
            display: flex; 
            align-items: center; 
            gap: 5px;
        }

        .input-container {
            display: flex; 
            gap: 6px; 
            align-items: center;
        }
        
        .chat-input {
            flex-grow: 1; 
            background: rgba(0,0,0,0.5); 
            border: 1px solid var(--border);
            padding: 10px 14px; 
            border-radius: 25px; 
            color: #fff;
            font-family: 'Rajdhani', sans-serif; 
            font-size: 0.9rem; 
            outline: none;
            -webkit-appearance: none;
        }
        
        .chat-input:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 15px rgba(0, 176, 255, 0.15); 
        }

        .btn {
            background: rgba(0, 176, 255, 0.1); 
            border: 1px solid var(--primary);
            color: var(--primary); 
            width: 40px; 
            height: 40px; 
            border-radius: 50%;
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            transition: 0.2s; 
            flex-shrink: 0;
            min-width: 40px;
            min-height: 40px;
        }
        
        .btn:active { 
            transform: scale(0.95); 
            background: rgba(0, 176, 255, 0.2); 
        }
        
        .btn.listening { 
            background: var(--accent); 
            color: #fff; 
            border-color: var(--accent); 
            animation: pulseRed 1s infinite; 
        }
        
        .btn svg { 
            width: 18px; 
            height: 18px; 
            stroke: currentColor; 
            fill: none; 
            stroke-width: 2; 
        }

        .typing-indicator { 
            font-size: 0.7rem; 
            color: var(--primary); 
            margin-left: 15px; 
            margin-bottom: 3px; 
            opacity: 0; 
        }
        
        .typing-indicator.active { 
            opacity: 1; 
            animation: pulse 1s infinite; 
        }
        
        #fileInput { 
            display: none; 
        }

        /* --- COMMAND SUGGESTIONS --- */
        .suggestions {
            display: flex;
            gap: 6px;
            padding: 6px 12px;
            overflow-x: auto;
            border-bottom: 1px solid rgba(0, 176, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }
        
        .suggestion-chip {
            padding: 5px 10px;
            background: rgba(0, 176, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 15px;
            font-size: 0.75rem;
            color: var(--primary);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .suggestion-chip:active { 
            background: rgba(0, 176, 255, 0.2);
        }

        /* --- FILE UPLOAD BUTTONS --- */
        .upload-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .upload-btn {
            flex: 1;
            padding: 10px;
            background: rgba(0, 176, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--primary);
            font-size: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn:active {
            background: rgba(0, 176, 255, 0.2);
        }

        /* --- MODALS --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-panel);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            color: var(--primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- VOICE SELECTION --- */
        .voice-option {
            background: rgba(0, 176, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .voice-option:hover {
            background: rgba(0, 176, 255, 0.2);
        }

        .voice-option.selected {
            background: rgba(0, 176, 255, 0.3);
            border-color: var(--primary);
        }

        .voice-name {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .voice-details {
            font-size: 0.7rem;
            color: #aaa;
            margin-top: 3px;
        }

        .voice-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .voice-test-btn, .voice-select-btn {
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            font-size: 0.7rem;
            cursor: pointer;
            flex: 1;
        }

        .voice-test-btn {
            background: rgba(0, 176, 255, 0.2);
            color: var(--primary);
        }

        .voice-select-btn {
            background: var(--primary);
            color: #fff;
        }

        /* --- ANIMATIONS --- */
        @keyframes spin { 
            100% { 
                transform: rotate(360deg); 
            } 
        }
        
        @keyframes breathe { 
            0%, 100% { 
                transform: scale(1); 
            } 
            50% { 
                transform: scale(1.02); 
            } 
        }
        
        @keyframes blink { 
            0%, 90%, 100% { 
                transform: scaleY(1); 
            } 
            95% { 
                transform: scaleY(0.1); 
            } 
        }
        
        @keyframes pulse { 
            0% { 
                opacity: 0.5; 
            } 
            50% { 
                opacity: 1; 
            } 
            100% { 
                opacity: 0.5; 
            } 
        }
        
        @keyframes pulseRed { 
            0% { 
                box-shadow: 0 0 0 0 rgba(0, 136, 255, 0.4); 
            } 
            70% { 
                box-shadow: 0 0 0 8px rgba(0, 136, 255, 0); 
            } 
            100% { 
                box-shadow: 0 0 0 0 rgba(0, 136, 255, 0); 
            } 
        }
        
        @keyframes fadeUp { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }

        @media (min-width: 768px) {
            .avatar-ring { 
                width: 110px; 
                height: 110px; 
            }
            
            .face-structure { 
                width: 80px; 
                height: 80px; 
            }
            
            .suggestion-chip {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .chat-input {
                padding: 12px 16px;
                font-size: 1rem;
            }
            
            .btn {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>

    <div class="grid-bg"></div>

    <header>
        <div class="brand">
            FTGAMERV2 AI <span class="owner-badge">@FTGAMERV2</span>
        </div>
        <div class="header-controls">
            <div class="status-badge">
                <div class="status-dot"></div> <span id="systemStatus">ONLINE</span>
            </div>
            <button class="settings-btn" onclick="showVoiceModal()" title="Voice Settings">
                ‚öôÔ∏è
            </button>
        </div>
    </header>

    <div class="avatar-container">
        <div class="avatar-ring">
            <div class="face-structure">
                <div class="eyes-container">
                    <div class="eye"></div>
                    <div class="eye"></div>
                </div>
                <div class="mouth-container" id="mouthViz">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Suggestions -->
    <div class="suggestions">
        <div class="suggestion-chip" onclick="quickCommand('Hello, how are you?')">Hello</div>
        <div class="suggestion-chip" onclick="quickCommand('What time is it?')">Time</div>
        <div class="suggestion-chip" onclick="quickCommand('I need help')">Help</div>
        <div class="suggestion-chip" onclick="quickCommand('Tell me a joke')">Joke</div>
        <div class="suggestion-chip" onclick="quickCommand('Scan this image')">Scan</div>
    </div>

    <div class="chat-area" id="chatContainer">
        <div class="msg ai">
            <strong>ü§ñ AI ASSISTANT:</strong> Online & Ready!<br>
            Hello! I'm <strong>Luna</strong>, your AI assistant. <span style="color:var(--primary)">(Female Voice)</span><br>
            I can help you with: <br>
            ‚Ä¢ üìÅ <strong>File uploads</strong> (images, PDFs, documents)<br>
            ‚Ä¢ üí¨ <strong>Chat in English or Hinglish</strong><br>
            ‚Ä¢ üîä <strong>Custom voice selection</strong><br>
            ‚Ä¢ üîç <strong>Image analysis</strong><br>
            ‚Ä¢ üì∏ <strong>Live camera capture</strong><br><br>
            Upload a file or ask me anything!
        </div>
    </div>
    
    <div class="typing-indicator" id="typingInd">PROCESSING...</div>

    <div class="input-wrapper">
        <!-- File Upload Buttons -->
        <div class="upload-buttons">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                üìÅ Upload File
            </button>
            <button class="upload-btn" onclick="startCamera()">
                üì∏ Open Camera
            </button>
        </div>
        
        <div class="preview-container" id="previewContainer"></div>
        
        <div class="input-container">
            <input type="file" id="fileInput" accept="image/*, .txt, .pdf, .jpg, .jpeg, .png, .doc, .docx" onchange="handleFileUpload(this.files)">
            
            <input type="text" class="chat-input" id="messageInput" placeholder="Type your message or use camera..." autocomplete="off">
            
            <button class="btn" id="voiceBtn" title="Voice Input">
                <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
            </button>
            
            <button class="btn" id="sendBtn" title="Send">
                <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>

    <!-- Voice Selection Modal -->
    <div id="voiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üéµ Voice Selection</div>
                <button class="close-btn" onclick="closeVoiceModal()">√ó</button>
            </div>
            <div id="voiceList">
                <p style="color:#aaa; font-size:0.8rem; margin-bottom:15px;">
                    Select a voice and test it. Your choice will be saved.
                </p>
                <div id="voicesContainer">
                    <!-- Voices will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì∏ Live Camera</div>
                <button class="close-btn" onclick="closeCamera()">√ó</button>
            </div>
            <video id="cameraFeed" autoplay playsinline style="width:100%; border-radius:10px; border:2px solid var(--border);"></video>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="capturePhoto()" style="flex:1; padding:12px; background:var(--accent); color:#fff; border:none; border-radius:10px; cursor:pointer;">
                    üì∑ Capture
                </button>
                <button onclick="closeCamera()" style="flex:1; padding:12px; background:#666; color:#fff; border:none; border-radius:10px; cursor:pointer;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const typingInd = document.getElementById('typingInd');
        const systemStatus = document.getElementById('systemStatus');
        const cameraModal = document.getElementById('cameraModal');
        const cameraFeed = document.getElementById('cameraFeed');
        const voiceModal = document.getElementById('voiceModal');
        const voicesContainer = document.getElementById('voicesContainer');
        
        let selectedFile = null;
        let isProcessing = false;
        let conversationHistory = [];
        let speechQueue = [];
        let isSpeaking = false;
        let mouthInterval;
        let voiceEnabled = true;
        let cameraStream = null;
        let selectedVoice = null;
        let useHinglish = true;
        let availableVoices = [];

        // --- LOAD SAVED VOICE ---
        function loadSavedVoice() {
            const savedVoice = localStorage.getItem('ftg_selected_voice');
            if (savedVoice) {
                selectedVoice = JSON.parse(savedVoice);
                console.log("Loaded voice:", selectedVoice);
            }
        }

        // --- VOICE SELECTION MODAL (FIXED) ---
        function showVoiceModal() {
            voiceModal.style.display = 'flex';
            loadVoices();
        }

        function closeVoiceModal() {
            voiceModal.style.display = 'none';
        }

        function loadVoices() {
            availableVoices = window.speechSynthesis.getVoices();
            voicesContainer.innerHTML = '';
            
            if (availableVoices.length === 0) {
                voicesContainer.innerHTML = '<p style="color:#ff6666; text-align:center;">No voices available. Try refreshing the page.</p>';
                setTimeout(loadVoices, 1000);
                return;
            }
            
            // Group voices by language
            const voiceGroups = {};
            availableVoices.forEach(voice => {
                const lang = voice.lang || 'unknown';
                if (!voiceGroups[lang]) voiceGroups[lang] = [];
                voiceGroups[lang].push(voice);
            });
            
            // Create UI for each language group
            Object.keys(voiceGroups).sort().forEach(lang => {
                const groupDiv = document.createElement('div');
                groupDiv.style.marginBottom = '15px';
                groupDiv.innerHTML = `<div style="font-size:0.8rem; color:var(--primary); margin-bottom:5px; border-bottom:1px solid var(--border); padding-bottom:3px;">${lang}</div>`;
                
                voiceGroups[lang].forEach(voice => {
                    const voiceDiv = document.createElement('div');
                    voiceDiv.className = 'voice-option';
                    voiceDiv.dataset.voiceName = voice.name;
                    
                    if (selectedVoice && voice.name === selectedVoice.name) {
                        voiceDiv.classList.add('selected');
                    }
                    
                    voiceDiv.innerHTML = `
                        <div class="voice-name">${voice.name}</div>
                        <div class="voice-details">${voice.localService ? 'Local' : 'System'} ‚Ä¢ ${voice.default ? 'Default' : 'Standard'}</div>
                        <div class="voice-controls">
                            <button class="voice-test-btn" onclick="testVoice('${voice.name}')">Test</button>
                            <button class="voice-select-btn" onclick="selectVoice('${voice.name}')">Select</button>
                        </div>
                    `;
                    
                    groupDiv.appendChild(voiceDiv);
                });
                
                voicesContainer.appendChild(groupDiv);
            });
        }

        function testVoice(voiceName) {
            // Stop any ongoing speech
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            const voices = window.speechSynthesis.getVoices();
            const voice = voices.find(v => v.name === voiceName);
            
            if (voice) {
                const utterance = new SpeechSynthesisUtterance();
                utterance.voice = voice;
                utterance.text = "Hello! This is a test of my voice. How do I sound?";
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                utterance.lang = voice.lang || 'en-US';
                
                // Add event listeners for debugging
                utterance.onstart = () => console.log(`Testing voice: ${voice.name}`);
                utterance.onend = () => console.log(`Voice test ended: ${voice.name}`);
                utterance.onerror = (e) => console.error(`Voice test error: ${e.error}`, voice);
                
                window.speechSynthesis.speak(utterance);
            } else {
                console.error("Voice not found:", voiceName);
                alert("Voice not found. Please try again.");
            }
        }

        function selectVoice(voiceName) {
            const voices = window.speechSynthesis.getVoices();
            const voice = voices.find(v => v.name === voiceName);
            
            if (voice) {
                selectedVoice = voice;
                localStorage.setItem('ftg_selected_voice', JSON.stringify({
                    name: voice.name,
                    lang: voice.lang,
                    voiceURI: voice.voiceURI
                }));
                
                // Update UI
                document.querySelectorAll('.voice-option').forEach(el => {
                    el.classList.remove('selected');
                    if (el.dataset.voiceName === voiceName) {
                        el.classList.add('selected');
                    }
                });
                
                addMessage(`<strong>üéµ VOICE SET:</strong> ${voice.name} (${voice.lang})`, false);
                speak("Voice change ho gaya! Ab main is voice mein baat karungi.");
            }
        }

        // --- CAMERA FUNCTIONS ---
        async function startCamera() {
            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false 
                });
                
                cameraFeed.srcObject = cameraStream;
                cameraModal.style.display = 'flex';
                
                await cameraFeed.play();
                
            } catch (err) {
                console.error("Camera error:", err);
                addMessage(`<strong>‚ö†Ô∏è CAMERA ERROR:</strong> ${err.message}<br>Please allow camera permissions.`, false);
                speak("Camera access nahi mila. Permission check kijiye.");
            }
        }

        function capturePhoto() {
            if (!cameraStream || !cameraFeed.videoWidth) {
                addMessage("<strong>‚ö†Ô∏è ERROR:</strong> Camera not ready", false);
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = cameraFeed.videoWidth;
            canvas.height = cameraFeed.videoHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(function(blob) {
                if (blob) {
                    selectedFile = new File([blob], `camera_${Date.now()}.jpg`, { type: 'image/jpeg' });
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewContainer.innerHTML = `
                            <div style="display:flex; align-items:center; gap:8px;">
                                <img src="${e.target.result}" style="width:40px; height:40px; border-radius:5px; border:1px solid var(--border);">
                                <div>
                                    <div style="font-size:0.7rem; color:var(--primary)">üì∏ Camera Photo</div>
                                    <div style="font-size:0.6rem; color:#aaa">Click to analyze</div>
                                </div>
                                <span style="cursor:pointer; color:#ff5555; margin-left:5px; font-weight:bold" onclick="clearFile()">‚úñ</span>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(blob);
                    
                    closeCamera();
                    addMessage(`<strong>üì∏ PHOTO CAPTURED:</strong> Ready for analysis!`, false);
                    speak("Photo capture ho gaya! Ab main isko analyze kar sakti hoon.");
                }
            }, 'image/jpeg', 0.8);
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            cameraModal.style.display = 'none';
        }

        // --- FILE UPLOAD ---
        function handleFileUpload(files) {
            if (files.length > 0) {
                selectedFile = files[0];
                
                if (selectedFile.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewContainer.innerHTML = `
                            <div style="display:flex; align-items:center; gap:8px;">
                                <img src="${e.target.result}" style="width:40px; height:40px; border-radius:5px; border:1px solid var(--border);">
                                <div>
                                    <div style="font-size:0.7rem; color:var(--primary)">üìÑ ${selectedFile.name}</div>
                                    <div style="font-size:0.6rem; color:#aaa">${formatFileSize(selectedFile.size)}</div>
                                </div>
                                <span style="cursor:pointer; color:#ff5555; margin-left:5px; font-weight:bold" onclick="clearFile()">‚úñ</span>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(selectedFile);
                    
                    addMessage(`<strong>üìÅ FILE UPLOADED:</strong> ${selectedFile.name}`, false);
                    speak("File upload ho gaya! Ab main isko analyze kar sakti hoon.");
                } else {
                    previewContainer.innerHTML = `
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:40px; height:40px; border-radius:5px; border:1px solid var(--border); display:flex; align-items:center; justify-content:center; background:rgba(0,176,255,0.1);">
                                üìÑ
                            </div>
                            <div>
                                <div style="font-size:0.7rem; color:var(--primary)">${selectedFile.name}</div>
                                <div style="font-size:0.6rem; color:#aaa">${formatFileSize(selectedFile.size)}</div>
                            </div>
                            <span style="cursor:pointer; color:#ff5555; margin-left:5px; font-weight:bold" onclick="clearFile()">‚úñ</span>
                        </div>
                    `;
                    addMessage(`<strong>üìÅ FILE UPLOADED:</strong> ${selectedFile.name}`, false);
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        window.clearFile = function() {
            selectedFile = null;
            fileInput.value = '';
            previewContainer.innerHTML = '';
        };

        // --- QUICK COMMANDS ---
        window.quickCommand = function(command) {
            messageInput.value = command;
            sendMessage();
        };

        const commandShortcuts = {
            '/clear': () => {
                chatContainer.innerHTML = '<div class="msg ai"><strong>ü§ñ LUNA:</strong> Chat cleared!</div>';
                conversationHistory = [];
            },
            '/help': () => {
                addMessage(`<strong>ü§ñ LUNA'S COMMANDS:</strong><br>
                ‚Ä¢ <code>/clear</code> - Clear chat<br>
                ‚Ä¢ <code>/help</code> - Show help<br>
                ‚Ä¢ <code>/voice</code> - Voice selection<br>
                ‚Ä¢ <code>/camera</code> - Open camera<br>
                ‚Ä¢ <code>/scan</code> - Scan uploaded file<br>
                ‚Ä¢ <code>/hinglish</code> - Toggle Hinglish mode`, false);
            },
            '/voice': () => showVoiceModal(),
            '/camera': () => startCamera(),
            '/scan': () => {
                if (selectedFile) {
                    addMessage(`<strong>ü§ñ LUNA:</strong> Scanning ${selectedFile.name}...`, false);
                    messageInput.value = `Analyze this ${selectedFile.type.startsWith('image/') ? 'image' : 'file'}`;
                    sendMessage();
                } else {
                    addMessage(`<strong>ü§ñ LUNA:</strong> Please upload or take a photo first`, false);
                }
            },
            '/hinglish': () => {
                useHinglish = !useHinglish;
                addMessage(`<strong>ü§ñ LUNA:</strong> Hinglish mode ${useHinglish ? 'ON' : 'OFF'}`, false);
                speak(useHinglish ? "Ab main Hinglish mein baat karungi!" : "Now I will speak in English only.");
            }
        };

        // --- CONTENT FILTER ---
        function filterInappropriateContent(text) {
            const inappropriateWords = [
                'fuck', 'shit', 'asshole', 'bitch', 'dick', 'pussy', 'bastard', 'motherfucker',
                'chutiya', 'bhosdike', 'madarchod', 'behenchod', 'lund', 'gaand', 'randi'
            ];
            
            const lowerText = text.toLowerCase();
            for (const word of inappropriateWords) {
                if (lowerText.includes(word)) {
                    return true;
                }
            }
            return false;
        }

        // --- UI UTILITIES ---
        function showTyping() {
            typingInd.classList.add('active');
            systemStatus.innerText = "BUSY";
        }

        function hideTyping() {
            typingInd.classList.remove('active');
            systemStatus.innerText = "ONLINE";
        }

        function processText(text) {
            let formatted = text
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/~~(.*?)~~/g, '<del>$1</del>')
                .replace(/\n/g, '<br>');
                
            return formatted;
        }

        function addMessage(content, isUser, isError = false) {
            const div = document.createElement('div');
            if (isError) {
                div.className = 'msg error';
            } else {
                div.className = `msg ${isUser ? 'user' : 'ai'}`;
            }
            div.innerHTML = processText(content);
            chatContainer.appendChild(div);
            
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 10);
        }

        // --- VOICE SYSTEM (FIXED) ---
        function speak(text) {
            if (!window.speechSynthesis || !voiceEnabled || !text || text.trim().length < 3) return;
            
            window.speechSynthesis.cancel();
            animateMouth(false);
            
            const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
            
            speechQueue = [];
            isSpeaking = false;
            
            sentences.forEach((sentence, index) => {
                const trimmed = sentence.trim();
                if (trimmed.length > 2) {
                    speechQueue.push({ text: trimmed, delay: index * 800 });
                }
            });
            
            processSpeechQueue();
        }

        function processSpeechQueue() {
            if (speechQueue.length === 0) {
                isSpeaking = false;
                animateMouth(false);
                return;
            }
            
            isSpeaking = true;
            const item = speechQueue.shift();
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(item.text.substring(0, 300));
                
                // Get current voices
                const voices = window.speechSynthesis.getVoices();
                
                if (selectedVoice) {
                    // Try to find the exact voice
                    const voice = voices.find(v => 
                        v.name === selectedVoice.name && 
                        v.lang === selectedVoice.lang
                    );
                    
                    if (voice) {
                        utterance.voice = voice;
                        utterance.lang = voice.lang;
                    } else {
                        // Fallback to any voice with same language
                        const fallbackVoice = voices.find(v => v.lang === selectedVoice.lang);
                        if (fallbackVoice) {
                            utterance.voice = fallbackVoice;
                            utterance.lang = fallbackVoice.lang;
                        }
                    }
                }
                
                // If no voice selected or found, use default
                if (!utterance.voice) {
                    const defaultVoice = voices.find(v => v.default) || voices[0];
                    if (defaultVoice) {
                        utterance.voice = defaultVoice;
                        utterance.lang = defaultVoice.lang;
                    }
                }
                
                // Hinglish settings
                if (useHinglish && utterance.lang.includes('en')) {
                    utterance.rate = 0.85;
                    utterance.pitch = 1.2;
                } else {
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                }
                utterance.volume = 1.0;
                
                utterance.onstart = () => animateMouth(true);
                utterance.onend = () => {
                    setTimeout(() => processSpeechQueue(), 300);
                };
                utterance.onerror = (e) => {
                    console.error('Speech error:', e);
                    setTimeout(() => processSpeechQueue(), 300);
                };
                
                window.speechSynthesis.speak(utterance);
            }, item.delay);
        }

        // --- MOUTH ANIMATION ---
        function animateMouth(active) {
            const bars = document.querySelectorAll('.bar');
            
            if (active) {
                if (!mouthInterval) {
                    mouthInterval = setInterval(() => {
                        bars.forEach(b => {
                            b.style.height = Math.random() * 8 + 2 + 'px';
                        });
                    }, 100);
                }
            } else {
                clearInterval(mouthInterval);
                mouthInterval = null;
                bars.forEach(b => b.style.height = '2px');
            }
        }

        // --- IMAGE ANALYSIS ---
        async function analyzeImage(file) {
            return new Promise((resolve) => {
                if (!file.type.startsWith('image/')) {
                    resolve("This is not an image file. I can only analyze images.");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Basic image analysis
                        const analysis = {
                            width: img.width,
                            height: img.height,
                            aspectRatio: (img.width / img.height).toFixed(2),
                            size: formatFileSize(file.size),
                            format: file.type.split('/')[1].toUpperCase(),
                            colors: []
                        };
                        
                        // Create canvas for color analysis
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        // Get dominant colors
                        try {
                            const imageData = ctx.getImageData(0, 0, 100, 100).data;
                            const colorCount = {};
                            for (let i = 0; i < imageData.length; i += 4) {
                                const r = imageData[i];
                                const g = imageData[i + 1];
                                const b = imageData[i + 2];
                                const color = `${r},${g},${b}`;
                                colorCount[color] = (colorCount[color] || 0) + 1;
                            }
                            
                            const sortedColors = Object.entries(colorCount)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 3)
                                .map(([color]) => color);
                            
                            analysis.colors = sortedColors;
                        } catch (e) {
                            console.log("Color analysis skipped:", e);
                        }
                        
                        // Generate response
                        let response = `üì∏ **IMAGE ANALYSIS COMPLETE:**\n\n`;
                        response += `‚Ä¢ **Dimensions:** ${analysis.width} √ó ${analysis.height} pixels\n`;
                        response += `‚Ä¢ **Aspect Ratio:** ${analysis.aspectRatio}\n`;
                        response += `‚Ä¢ **File Size:** ${analysis.size}\n`;
                        response += `‚Ä¢ **Format:** ${analysis.format}\n`;
                        
                        if (analysis.colors.length > 0) {
                            response += `‚Ä¢ **Dominant Colors:** RGB(${analysis.colors[0]})`;
                            if (analysis.colors.length > 1) {
                                response += `, RGB(${analysis.colors[1]})`;
                            }
                            if (analysis.colors.length > 2) {
                                response += `, RGB(${analysis.colors[2]})`;
                            }
                            response += `\n`;
                        }
                        
                        response += `\n**What would you like to know about this image?**\n`;
                        response += `You can ask me to describe it, identify objects, or suggest edits.`;
                        
                        if (useHinglish) {
                            response = `üì∏ **IMAGE ANALYSIS COMPLETE:**\n\n`;
                            response += `‚Ä¢ **Size:** ${analysis.width} √ó ${analysis.height} pixels\n`;
                            response += `‚Ä¢ **File ka size:** ${analysis.size}\n`;
                            response += `‚Ä¢ **Format:** ${analysis.format}\n\n`;
                            response += `Image clear hai aur details visible hain. Kya aap iske bare mein kuch specific janana chahte hain?`;
                        }
                        
                        resolve(response);
                    };
                    img.onerror = () => {
                        resolve("Image load nahi ho payi. Kya aap dubara try karna chahenge?");
                    };
                    img.src = e.target.result;
                };
                reader.onerror = () => {
                    resolve("File read nahi ho payi. Please try again.");
                };
                reader.readAsDataURL(file);
            });
        }

        // --- NETWORK COMMUNICATION ---
        async function sendMessage() {
            if (isProcessing) return;
            
            const text = messageInput.value.trim();
            if (!text && !selectedFile) return;
            
            // Check for inappropriate content
            if (filterInappropriateContent(text)) {
                addMessage(`<strong>‚ö†Ô∏è CONTENT WARNING:</strong> Please maintain respectful conversation. I'm here to help you with genuine queries.`, false, true);
                speak("Please use respectful language. Main aapki madad karne ke liye hoon.");
                messageInput.value = '';
                return;
            }
            
            // Check for commands
            if (text.startsWith('/')) {
                const parts = text.split(' ');
                const cmd = parts[0];
                
                if (commandShortcuts[cmd]) {
                    commandShortcuts[cmd]();
                    messageInput.value = '';
                    return;
                }
            }
            
            isProcessing = true;
            
            // Stop speech
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                animateMouth(false);
            }
            
            // Display user message
            if (text) addMessage(text, true);
            if (selectedFile) {
                addMessage(`üìé [File: ${selectedFile.name}]`, true);
            }
            
            // Clear input
            messageInput.value = '';
            
            showTyping();
            
            try {
                let responseText = '';
                
                // Handle image analysis
                if (selectedFile && selectedFile.type.startsWith('image/')) {
                    if (text.toLowerCase().includes('analyze') || 
                        text.toLowerCase().includes('scan') || 
                        text.toLowerCase().includes('batao') ||
                        text.toLowerCase().includes('kya hora')) {
                        
                        responseText = await analyzeImage(selectedFile);
                        
                    } else {
                        // Generic image response
                        responseText = useHinglish 
                            ? `Aapne image upload ki hai. Image ka naam ${selectedFile.name} hai. Kya aap isko analyze karna chahte hain? "Scan this image" ya "Batao isme kya hai" bolein.`
                            : `You've uploaded an image named ${selectedFile.name}. Would you like me to analyze it? Say "Scan this image" or "What's in this image?".`;
                    }
                    
                } else {
                    // Text-only response
                    responseText = generateSmartResponse(text, selectedFile);
                }
                
                hideTyping();
                
                // Display response
                addMessage(responseText, false);
                
                // Speak response
                if (voiceEnabled) {
                    setTimeout(() => speak(responseText), 500);
                }
                
            } catch (err) {
                hideTyping();
                console.error("Error:", err);
                
                const response = useHinglish 
                    ? "Mujhe temporary issue aa raha hai. Thodi der baad try karein."
                    : "I'm having a temporary issue. Please try again in a moment.";
                
                addMessage(response, false);
                if (voiceEnabled) speak(response);
            } finally {
                isProcessing = false;
            }
        }

        // --- SMART RESPONSE GENERATOR ---
        function generateSmartResponse(text, file) {
            const lowerText = text.toLowerCase();
            
            // Handle greeting
            if (lowerText.includes('hello') || lowerText.includes('hi') || lowerText.includes('namaste')) {
                return useHinglish 
                    ? "Namaste! Main Luna hoon. Aapka din kaisa chal raha hai? Kaise madad kar sakti hoon?"
                    : "Hello! I'm Luna. How's your day going? How can I help you today?";
            }
            
            // Handle time query
            if (lowerText.includes('time') || lowerText.includes('samay')) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                return useHinglish 
                    ? `Abhi time hai ${timeStr} (IST).`
                    : `The current time is ${timeStr} (IST).`;
            }
            
            // Handle joke request
            if (lowerText.includes('joke') || lowerText.includes('haso') || lowerText.includes('mazak')) {
                const jokes = useHinglish ? [
                    "Ek scientist ne atom se pucha: Tum itne chhote kyun ho? Atom bola: Kyunki main atom hoon!",
                    "Dost: Tumhare pass kitne apps hain? Main: 100 se zyada. Dost: Par phone mein toh sirf 20 hain! Main: Baaki sab pending hain update ke!",
                    "Teacher: Agar tumhare pass 10 apples hain... Student: Sir, main toh Apple ka phone use karta hoon!"
                ] : [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "I told my wife she was drawing her eyebrows too high. She looked surprised.",
                    "Why don't eggs tell jokes? They'd crack each other up!"
                ];
                const joke = jokes[Math.floor(Math.random() * jokes.length)];
                return useHinglish 
                    ? `${joke}\n\nKaisa laga? Aur sunna hai?`
                    : `${joke}\n\nWant to hear another one?`;
            }
            
            // Handle help request
            if (lowerText.includes('help') || lowerText.includes('madad')) {
                return `<strong>${useHinglish ? 'ü§ñ LUNA KI MADAD:' : 'ü§ñ LUNA HELP:'}</strong><br>
                ${useHinglish ? 
                    'Main aapki kaise madad kar sakti hoon:<br>' +
                    '1. üì∏ <strong>Images analyze</strong> karo (upload ya camera se)<br>' +
                    '2. üòÑ <strong>Jokes</strong> suno<br>' +
                    '3. üïí <strong>Time</strong> batao<br>' +
                    '4. üîä <strong>Voice change</strong> karo (Settings se)<br>' +
                    '5. üí¨ <strong>General baat-cheet</strong> karo<br><br>' +
                    'Koi specific help chahiye?'
                    :
                    'Here\'s what I can help you with:<br>' +
                    '1. üì∏ <strong>Analyze images</strong> (upload or camera)<br>' +
                    '2. üòÑ <strong>Tell jokes</strong><br>' +
                    '3. üïí <strong>Check time</strong><br>' +
                    '4. üîä <strong>Change voice</strong> (from Settings)<br>' +
                    '5. üí¨ <strong>General conversation</strong><br><br>' +
                    'Need specific help?'
                }`;
            }
            
            // Handle "what's happening" or similar queries
            if (lowerText.includes('kya hora') || lowerText.includes('what happening') || lowerText.includes('batao')) {
                if (file) {
                    return useHinglish
                        ? "Aapne image upload ki hai. Main isko analyze kar rahi hoon. Thodi der rukiye..."
                        : "You've uploaded an image. I'm analyzing it. Please wait a moment...";
                } else {
                    return useHinglish
                        ? "Abhi kuch khaas nahi ho raha. Aap kya karna chahte hain? Image upload karein, joke sunen, ya kuch aur?"
                        : "Nothing much happening right now. What would you like to do? Upload an image, hear a joke, or something else?";
                }
            }
            
            // Handle "bruh" or similar casual responses
            if (lowerText.includes('bruh') || lowerText.includes('bro') || lowerText.includes('yaar')) {
                return useHinglish
                    ? "Haan batao? Kya help chahiye? üòÑ"
                    : "Yeah, what's up? Need help with something? üòÑ";
            }
            
            // Default context-aware response
            if (file) {
                return useHinglish
                    ? `Aapne ${file.name} upload kiya hai. Kya aap iske bare mein kuch specific janana chahte hain? Ya phir "Scan this" bolein analysis ke liye.`
                    : `You've uploaded ${file.name}. Would you like to know something specific about it? Or say "Scan this" for analysis.`;
            }
            
            // Generic intelligent response
            const responses = useHinglish ? [
                `Aapne kaha: "${text}". Ye ek interesting topic hai! Main iske bare mein aur bata sakti hoon. Kya aap specific details chahiye?`,
                `"${text}" - Achha sawaal hai! Main aapko iske bare mein detailed information de sakti hoon.`,
                `Wah! "${text}" ke bare mein main aapki madad kar sakti hoon. Kya aap kuch specific poochna chahte hain?`
            ] : [
                `You said: "${text}". That's an interesting topic! I can tell you more about it. Would you like specific details?`,
                `"${text}" - Good question! I can provide detailed information about that.`,
                `Interesting! I can help you with "${text}". What specific aspect would you like to know about?`
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // --- VOICE RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = useHinglish ? 'hi-IN' : 'en-US';
            
            voiceBtn.addEventListener('click', () => {
                if (voiceBtn.classList.contains('listening')) {
                    recognition.stop();
                } else {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.log("Mic error:", e);
                    }
                }
            });
            
            recognition.onstart = () => {
                voiceBtn.classList.add('listening');
                messageInput.placeholder = useHinglish ? "Sun rahi hoon..." : "Listening...";
            };
            
            recognition.onend = () => {
                voiceBtn.classList.remove('listening');
                messageInput.placeholder = "Type your message or use camera...";
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                messageInput.value = transcript;
                setTimeout(sendMessage, 500);
            };
            
            recognition.onerror = (event) => {
                voiceBtn.classList.remove('listening');
                messageInput.placeholder = "Mic error";
            };
            
        } else {
            voiceBtn.style.display = 'none';
        }

        // --- EVENT HANDLERS ---
        sendButton.onclick = sendMessage;
        
        messageInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Auto-focus
        setTimeout(() => messageInput.focus(), 500);
        
        // Initialize voices
        if (window.speechSynthesis) {
            // Load voices when ready
            const loadVoicesAndSelect = () => {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    loadSavedVoice();
                    // If no voice selected, choose default female voice
                    if (!selectedVoice) {
                        const femaleVoice = voices.find(v => 
                            v.name.includes('Female') || 
                            v.name.includes('Woman') || 
                            v.name.includes('Samantha') ||
                            v.name.includes('Zira') ||
                            v.name.includes('Google ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä')
                        );
                        if (femaleVoice) {
                            selectedVoice = femaleVoice;
                            localStorage.setItem('ftg_selected_voice', JSON.stringify({
                                name: femaleVoice.name,
                                lang: femaleVoice.lang
                            }));
                        }
                    }
                }
            };
            
            if (speechSynthesis.getVoices().length > 0) {
                loadVoicesAndSelect();
            } else {
                speechSynthesis.addEventListener('voiceschanged', loadVoicesAndSelect);
            }
        }
        
        // Welcome message
        setTimeout(() => {
            if (voiceEnabled) {
                speak(useHinglish 
                    ? "Namaste! Main Luna hoon, aapki AI assistant. Main aapki file uploads, camera scanning, aur questions mein madad kar sakti hoon. Aaj main aapki kya madad kar sakti hoon?"
                    : "Hello! I'm Luna, your AI assistant. I can help you with file uploads, camera scanning, and answering questions. How can I assist you today?"
                );
            }
        }, 1500);
        
    </script>
</body>
</html>